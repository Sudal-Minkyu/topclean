<!DOCTYPE html>
<html lang="ko"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate ="~{layout/login}">

<th:block layout:fragment="script">
	<script type="text/javascript">

		 function loginActive() {

		 	const $userid = $("#userid");
		 	const $password = $("#password");

		 	if ($userid.val().trim() === '') {
		 		alertCaution("아이디를 입력하세요.");
		 		$userid.trigger('focus');
		 		return false;
		 	}
		 	if ($password.val().trim() === '') {
		 		alertCaution("비밀번호을 입력하세요.");
		 		$password.trigger('focus');
		 		return false;
		 	}

		 	const params = {
		 		userid : $userid.val(),
		 		password : $password.val()
		 	};

		 	const jsonString = JSON.stringify(params);

		 	console.log("로그인 실행");
		 	$.ajax({
		 		url: '/auth/login',
		 		type: 'post',
		 		data: jsonString,
		 		contentType: 'application/json',
		 		cache: false,
		 		error: function (req) {
		 			if(req.status === 401){
						$('.l-popup').removeClass('open');
						alertCaution("비밀번호가 틀렸습니다.", 1);
						$("#password").val("");
					}else{
						ajaxErrorMsg(req);
					}
		 		},
		 		success: function (res) {
		 			// console.log("로그인 되었습니다.");
		 			// console.log("AccessToken : "+res.sendData.tokenDto.accessToken);
		 			localStorage.setItem("Authorization",res.sendData.tokenDto.accessToken); // 로컬 웹스토리지안에 토큰을 저장한다.
					mainPage();
		 		}
		 	});
		 }

		 function mainPage(){
			 $(document).ajaxSend(function(e, xhr) { xhr.setRequestHeader("Authorization",localStorage.getItem('Authorization')); });
			 $.ajax({
			 	url: '/',
			 	type: 'get',
			 	contentType: 'application/json',
			 	cache: false,
			 	error: function (req) {
			 		ajaxErrorMsg(req);
			 	},
			 	success: function (res) {
					location.href= res.sendData.link;
			 		// console.log("이동완료");
			 	}
			 });
		 }
		 
		 // 가상키보드
		 let vkey;
		 $(function () {
		     vkey = new VKeyboard();
		 });
		 
		 let targetFieldID = ["userid", "password"];
		 
		 /* 각 가상 키보드의 제목 */
		 let targetFieldSubject = [
		     "ID를 입력해주세요",
		     "비밀번호를 입력해주세요"
		 ];
		 
		 function openVKeyboard(keyboardNum) {
			 vkey.showKeyboard(targetFieldID[keyboardNum], targetFieldSubject[keyboardNum]);
		 }


	</script>
</th:block>

<div layout:fragment="content" class="login-wrap">

	<div class="login">
		<h1 class="login__logo">
			<img src="/assets/images/logo__megashop.svg" alt="탑 크리닝업 메가샵" />
		</h1>
		<div class="login__form-box">
			<div class="login__input">
				<input type="text" id="userid" name="userid" placeholder="아이디" required >
				<button type="button" onclick="openVKeyboard(0)">키보드</button>
			</div>
			<div class="login__input">
				<input type="password" id="password" name="password" placeholder="비밀번호" required>
				<button type="button" onclick="openVKeyboard(1)">키보드</button>
			</div>
			<div class="login__check">
				<input type="checkbox" id="logincheck" class="login__check-input" />
				<label for="logincheck" class="login__check-label">아이디 저장</label>
			</div>
			<div><input class="login__btn" type="button" value="로그인" onclick="loginActive()" /></div>
		</div>
	</div>
	
	<div id="VKEY"></div>
</div>

</html>